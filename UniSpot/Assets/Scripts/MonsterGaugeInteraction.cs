using UnityEngine;
using UnityEngine.SceneManagement;
using UnityEngine.UI;
using System;
using TMPro;

public class MonsterGaugeInteraction : MonoBehaviour
{
    public Image gaugeImage; // Gauge_Frame의 Image 컴포넌트
    public float fixedIncreaseAmount = 0.1f; // 터치 시 게이지 증가량
    public float fillDecreaseSpeed = 0.1f; // 게이지 감소 속도
    public float delayBeforeDecrease = 1f; // 게이지 감소 전 대기 시간
    public GameObject resultSuccess; // Result_Success 오브젝트
    public GameObject resultFailed; // Result_Failed 오브젝트

    private bool isGaugeDecreasing = true; // 게이지 감소 상태 플래그
    private bool isCaptureFailed = false; // 포획 실패 상태 플래그
    private bool resultFailedActive = false; // Result_Failed 활성화 상태 플래그
    private bool resultSuccessActive = false; // Result_Success 활성화 상태 플래그

    public RectTransform frameCenter; // Frame_Center의 RectTransform
    private Rect frameRect;

    public GameObject slot1; // 슬롯 1 오브젝트
    public GameObject slot2; // 슬롯 2 오브젝트

    public WebSocketClient webSocketClient; // WebSocketClient의 인스턴스를 참조할 변수
    public static event Action OnCaptureSuccess; // 포획 성공 이벤트

    public TextMeshProUGUI moneyIncreaseText; // 증가시킬 money 값을 담는 TextMeshProUGUI 컴포넌트


    // 포획 성공 여부를 나타내는 변수
    public bool IsCaptureSuccessful { get; private set; }

    void Start()
    {
        // Frame_Center의 RectTransform을 스크린 좌표로 변환
        Vector3[] frameCorners = new Vector3[4];
        frameCenter.GetWorldCorners(frameCorners);
        frameRect = new Rect(frameCorners[0].x, frameCorners[0].y,
                             frameCorners[2].x - frameCorners[0].x,
                             frameCorners[2].y - frameCorners[0].y);

        // 게이지 감소를 딜레이 후에 시작
        StartCoroutine(StartDecreasingGaugeWithDelay());
    }

    void Update()
    {
        // 터치 입력 감지 (포획 실패 상태가 아닐 때만)
        if (Input.GetMouseButtonDown(0) && !isCaptureFailed && !resultSuccessActive)
        {
            Vector3 touchPosition = Input.mousePosition;

            // 터치 이벤트 발생
            HandleTouch(touchPosition);
        }
    }

    // 터치 이벤트 처리 메서드
    void HandleTouch(Vector3 touchPosition)
    {
        // 터치 위치가 Frame_Center 안에 있는지 확인
        if (frameRect.Contains(touchPosition))
        {
            IncreaseGaugeFixedAmount();
        }
        // Frame 영역 밖에서도 터치 이벤트가 발생하지만 게이지에 영향을 주지 않음
    }

    // 게이지 감소 시작 (딜레이 포함)
    System.Collections.IEnumerator StartDecreasingGaugeWithDelay()
    {
        Debug.Log("게이지 감소를 위한 대기 시간 시작.");
        // 지정된 딜레이 시간 동안 대기
        yield return new WaitForSeconds(delayBeforeDecrease);

        Debug.Log("게이지 감소 시작!");
        // 매 프레임마다 게이지 감소
        StartCoroutine(DecreaseGauge());
    }

    // 게이지를 점진적으로 감소시키는 코루틴
    System.Collections.IEnumerator DecreaseGauge()
    {
        while (gaugeImage.fillAmount > 0f && isGaugeDecreasing)
        {
            gaugeImage.fillAmount -= fillDecreaseSpeed * Time.deltaTime;
            yield return null; // 다음 프레임까지 대기
        }

        // 게이지가 모두 소모되었을 때
        if (gaugeImage.fillAmount <= 0f)
        {
            Debug.Log("게이지가 모두 소모되었습니다.");

            // 포획 실패 상태로 설정
            isCaptureFailed = true;

            // Result_Failed 활성화 및 상태 플래그 설정
            resultFailed.SetActive(true);
            resultFailedActive = true;

            // 5초 후에 메인 화면으로 이동
            yield return new WaitForSeconds(5f);
            SceneManager.LoadScene("Main Scene");
        }
    }

    // 터치 시 고정된 양만큼 게이지 증가
    void IncreaseGaugeFixedAmount()
    {
        // 게이지 증가
        gaugeImage.fillAmount += fixedIncreaseAmount;

        // 게이지가 최대치에 도달하면 성공 처리
        if (gaugeImage.fillAmount >= 1f)
        {
            gaugeImage.fillAmount = 1f; // 게이지 최대치 고정
            Debug.Log("게이지 최대치에 도달!");

            // 포획 성공 처리
            IsCaptureSuccessful = true; // 포획 성공을 기록

            // 포획 성공 이벤트 발생
            OnCaptureSuccess?.Invoke();

            // 게이지 감소 중지
            isGaugeDecreasing = false;

            // Result_Success 활성화 및 상태 플래그 설정
            resultSuccess.SetActive(true);
            resultSuccessActive = true;

            // TextMeshProUGUI의 텍스트를 정수로 변환하여 증가시킬 값으로 사용
            int increaseAmount = int.Parse(moneyIncreaseText.text);
            ServerData.userMoney += increaseAmount;
            Debug.Log("userMoney increased by " + increaseAmount + ". New value: " + ServerData.userMoney);

            // WebSocketClient를 통해 서버에 업데이트 전송
            if (webSocketClient != null)
            {
                webSocketClient.SendUpdateUserMoneyMessage(ServerData.userMoney);
            }
            else
            {
                Debug.LogWarning("WebSocketClient reference is not set.");
            }

            // 5초 후에 메인 화면으로 이동
            StartCoroutine(GoToMainSceneAfterDelay(5f));
        }
    }

    // 5초 후 메인 화면으로 이동
    System.Collections.IEnumerator GoToMainSceneAfterDelay(float delay)
    {
        yield return new WaitForSeconds(delay);
        SceneManager.LoadScene("Main Scene");
    }

    // 터치로 Result_Failed 또는 Result_Success 창이 비활성화되는 것을 방지
    void LateUpdate()
    {
        if (resultFailedActive && !resultFailed.activeSelf)
        {
            resultFailed.SetActive(true);
        }

        if (resultSuccessActive && !resultSuccess.activeSelf)
        {
            resultSuccess.SetActive(true);
        }
    }

    // 슬롯 1 클릭 시 게이지 감소 수치 감소
    public void OnSlot1Clicked()
    {
        // 현재 money가 100 이상일 때
        if (ServerData.userMoney >= 100)
        {
            // 100 소모
            ServerData.userMoney -= 100;

            // WebSocketClient를 통해 서버에 업데이트 전송
            if (webSocketClient != null)
            {
                webSocketClient.SendUpdateUserMoneyMessage(ServerData.userMoney);
            }
            else
            {
                Debug.LogWarning("WebSocketClient reference is not set.");
            }

            Debug.Log("Slot 2 clicked: 100 money consumed. New money: " + ServerData.userMoney);

            // 게이지 증가량 10% 증가
            fixedIncreaseAmount *= 1.1f;
            Debug.Log("Gauge increase amount increased by 10%.");
        }
        else
        {
            Debug.LogWarning("Not enough money to use Slot 2.");
        }
    }

    // 슬롯 2 클릭 시 게이지 증가 수치 증가
    public void OnSlot2Clicked()
    {
        // 현재 money가 150 이상일 때
        if (ServerData.userMoney >= 150)
        {
            // 150 소모
            ServerData.userMoney -= 150;

            // WebSocketClient를 통해 서버에 업데이트 전송
            if (webSocketClient != null)
            {
                webSocketClient.SendUpdateUserMoneyMessage(ServerData.userMoney);
            }
            else
            {
                Debug.LogWarning("WebSocketClient reference is not set.");
            }

            Debug.Log("Slot 2 clicked: 150 money consumed. New money: " + ServerData.userMoney);

            // 게이지 증가량 10% 증가
            fixedIncreaseAmount *= 1.1f;
            Debug.Log("Gauge increase amount increased by 10%.");
        }
        else
        {
            Debug.LogWarning("Not enough money to use Slot 2.");
        }
    }

}
